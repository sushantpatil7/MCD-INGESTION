name: PR SQL Processing Automation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - master

env:
  AWS_REGION: us-east-1
  LAMBDA_FUNCTION_NAME: pr-sql-processor
  GH_TOKEN: ${{ github.token }}

jobs:
  check-merge-and-sql:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
      id-token: write   # REQUIRED for AWS OIDC

    steps:
      # ---------------------------------------------------
      # 1. Checkout repository
      # ---------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------------------------------------------
      # 2. Check if PR is mergeable
      # ---------------------------------------------------
      - name: Check if branch is mergeable
        id: check_mergeable
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO_OWNER=${{ github.repository_owner }}
          REPO_NAME=${{ github.event.repository.name }}

          MERGEABLE=$(gh api repos/$REPO_OWNER/$REPO_NAME/pulls/$PR_NUMBER --jq '.mergeable')

          echo "mergeable=${MERGEABLE}" >> $GITHUB_OUTPUT

          if [ "$MERGEABLE" = "false" ]; then
            echo "‚ùå Branch has merge conflicts"
          elif [ "$MERGEABLE" = "null" ]; then
            echo "‚è≥ Merge status pending, retrying..."
            sleep 5
            MERGEABLE=$(gh api repos/$REPO_OWNER/$REPO_NAME/pulls/$PR_NUMBER --jq '.mergeable')
            echo "mergeable=${MERGEABLE}" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Branch is mergeable"
          fi

      # ---------------------------------------------------
      # 3. Comment if merge conflict exists
      # ---------------------------------------------------
      - name: Handle merge conflicts
        if: steps.check_mergeable.outputs.mergeable == 'false'
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}

          COMMENT="‚ùå *Merge Conflict Detected*

          Please resolve merge conflicts locally and push the changes.
          This workflow will automatically re-run."

          gh pr comment $PR_NUMBER --body "$COMMENT"

      # ---------------------------------------------------
      # 4. Find newly added SQL files in sql_data/
      # ---------------------------------------------------
      - name: Find new SQL files
        if: steps.check_mergeable.outputs.mergeable == 'true'
        id: find_sql
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO_OWNER=${{ github.repository_owner }}
          REPO_NAME=${{ github.event.repository.name }}

          gh api repos/$REPO_OWNER/$REPO_NAME/pulls/$PR_NUMBER/files \
            --jq '.[] 
                  | select(.status == "added")
                  | select(.filename | startswith("sql_data/"))
                  | select(.filename | endswith(".sql"))
                  | .filename' > sql_files.txt

          FILE_COUNT=$(grep -c . sql_files.txt || true)
          echo "sql_file_count=${FILE_COUNT}" >> $GITHUB_OUTPUT

          if [ "$FILE_COUNT" -gt 0 ]; then
            echo "‚úÖ Found SQL files:"
            cat sql_files.txt
          else
            echo "‚ÑπÔ∏è No SQL files found"
          fi

      # ---------------------------------------------------
      # 5. Extract SQL content into JSON payload
      # ---------------------------------------------------
      - name: Extract SQL content from files
        if: steps.check_mergeable.outputs.mergeable == 'true' && steps.find_sql.outputs.sql_file_count > 0
        run: |
          echo '{' > sql_content.json
          echo '  "files": [' >> sql_content.json

          FIRST=true
          while IFS= read -r file; do
            [ -z "$file" ] && continue

            if [ "$FIRST" = false ]; then
              echo ',' >> sql_content.json
            fi
            FIRST=false

            CONTENT=$(jq -Rs . < "$file")

            echo "    {" >> sql_content.json
            echo "      \"filename\": \"$file\"," >> sql_content.json
            echo "      \"content\": $CONTENT" >> sql_content.json
            echo "    }" >> sql_content.json
          done < sql_files.txt

          echo '  ],' >> sql_content.json
          echo "  \"pr_number\": ${{ github.event.pull_request.number }}," >> sql_content.json
          echo "  \"pr_title\": \"${{ github.event.pull_request.title }}\"," >> sql_content.json
          echo "  \"pr_author\": \"${{ github.event.pull_request.user.login }}\"" >> sql_content.json
          echo '}' >> sql_content.json

          echo "üì¶ Payload:"
          cat sql_content.json

      # ---------------------------------------------------
      # 6. Configure AWS credentials (OIDC)
      # ---------------------------------------------------
      - name: Configure AWS credentials
        if: steps.check_mergeable.outputs.mergeable == 'true' && steps.find_sql.outputs.sql_file_count > 0
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # ---------------------------------------------------
      # 7. Invoke AWS Lambda with SQL payload
      # ---------------------------------------------------
      - name: Invoke Lambda
        if: steps.check_mergeable.outputs.mergeable == 'true' && steps.find_sql.outputs.sql_file_count > 0
        run: |
          aws lambda invoke \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --invocation-type RequestResponse \
            --payload file://sql_content.json \
            lambda_response.json

          echo "üìÑ Lambda response:"
          cat lambda_response.json

          if grep -q "FunctionError" lambda_response.json; then
            echo "‚ùå Lambda execution failed"
            exit 1
          fi

          echo "‚úÖ Lambda executed successfully"

      # ---------------------------------------------------
      # 8. Post success comment
      # ---------------------------------------------------
      - name: Post success comment
        if: success() && steps.check_mergeable.outputs.mergeable == 'true'
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}

          if [ "${{ steps.find_sql.outputs.sql_file_count }}" -gt 0 ]; then
            COMMENT="‚úÖ *PR Validation Complete*

            - No merge conflicts
            - SQL validated and sent to Lambda
            - Execution successful"
          else
            COMMENT="‚úÖ *PR Validation Complete*

            - No merge conflicts
            - No SQL files found"
          fi

          gh pr comment $PR_NUMBER --body "$COMMENT"

      # ---------------------------------------------------
      # 9. Post failure comment
      # ---------------------------------------------------
      - name: Post failure comment
        if: failure() && steps.check_mergeable.outputs.mergeable == 'true'
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}

          COMMENT="‚ùå *SQL Processing Failed*

          Lambda execution failed.  
          Please check GitHub Actions logs for details."

          gh pr comment $PR_NUMBER --body "$COMMENT"
