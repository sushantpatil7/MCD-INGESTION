name: SQL Deployment Automation

on:
  pull_request:
    types: [closed]

env:
  AWS_REGION: us-east-1
  LAMBDA_FUNCTION_NAME: mcd-sql-deploy

jobs:
  sql-deploy:
    if: ${{ github.event.pull_request.merged == true }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find changed SQL files
        id: find_sql
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO_OWNER=${{ github.repository_owner }}
          REPO_NAME=${{ github.event.repository.name }}

          gh api --paginate repos/$REPO_OWNER/$REPO_NAME/pulls/$PR_NUMBER/files \
            --jq '.[]
                  | select(.status != "removed")
                  | select(.filename | startswith("sql_data/deployment/"))
                  | select(.filename | endswith(".sql"))
                  | .filename' > sql_files.txt

          FILE_COUNT=$(grep -c . sql_files.txt || true)
          echo "sql_file_count=${FILE_COUNT}" >> $GITHUB_OUTPUT

          if [ "$FILE_COUNT" -gt 0 ]; then
            echo "Found SQL files:"
            cat sql_files.txt
          else
            echo "No SQL files found"
          fi

      - name: Create Lambda payload
        if: steps.find_sql.outputs.sql_file_count > 0
        run: |
          echo '{' > sql_content.json
          echo '  "deployment_id": "${{ github.event.pull_request.merge_commit_sha }}",' >> sql_content.json
          echo '  "pr_number": "${{ github.event.pull_request.number }}",' >> sql_content.json
          echo '  "repo": "${{ github.repository }}",' >> sql_content.json
          echo '  "branch": "${{ github.head_ref }}",' >> sql_content.json
          echo '  "files": [' >> sql_content.json
          FIRST=true

          while IFS= read -r file; do
            [ -z "$file" ] && continue
            [ "$FIRST" = false ] && echo ',' >> sql_content.json
            FIRST=false
            CONTENT=$(jq -Rs . < "$file")
            echo "    {\"filename\": \"$file\", \"content\": $CONTENT}" >> sql_content.json
          done < sql_files.txt

          echo '  ]' >> sql_content.json
          echo '}' >> sql_content.json
          cat sql_content.json

      - name: Configure AWS credentials
        if: steps.find_sql.outputs.sql_file_count > 0
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Invoke Lambda
        if: steps.find_sql.outputs.sql_file_count > 0
        run: |
          aws lambda invoke \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --invocation-type RequestResponse \
            --cli-binary-format raw-in-base64-out \
            --payload file://sql_content.json \
            lambda_response.json

          echo "Lambda response:"
          cat lambda_response.json

          if grep -q "FunctionError" lambda_response.json; then
            echo "❌ Lambda execution failed"
            exit 1
          fi

          if jq -e '.status == "FAILED"' lambda_response.json >/dev/null; then
            echo "❌ One or more SQL deployments failed"
            exit 1
          fi

          if jq -e '.results[] | select(.status == "FAILED")' lambda_response.json >/dev/null; then
            echo "❌ One or more SQL deployments failed"
            exit 1
          fi

          echo "✅ SQL deployments completed"

      - name: PR comment
        if: always() && steps.find_sql.outputs.sql_file_count > 0
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            BODY="✅ *SQL Deployment Complete*\n- Files processed: ${{ steps.find_sql.outputs.sql_file_count }}"
          else
            BODY="❌ *SQL Deployment Failed*\nCheck workflow logs for details."
          fi

          gh pr comment ${{ github.event.pull_request.number }} --body "$BODY"
