name: PR SQL Processing Automation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - master

env:
  AWS_REGION: eu-north-1
  LAMBDA_FUNCTION_NAME: new-lambda

jobs:
  check-merge-and-sql:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      # --------------------------------------------------
      # 1. Checkout code
      # --------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------------------
      # 2. Install GitHub CLI (already authenticated)
      # --------------------------------------------------
      - name: Install GitHub CLI
        run: |
          sudo apt update
          sudo apt install -y gh
          gh --version

      # --------------------------------------------------
      # 3. Find newly added SQL files
      # --------------------------------------------------
      - name: Find new SQL files
        id: find_sql
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          OWNER=${{ github.repository_owner }}
          REPO=${{ github.event.repository.name }}

          gh api repos/$OWNER/$REPO/pulls/$PR_NUMBER/files \
            --jq '.[] 
                  | select(.status=="added")
                  | select(.filename | startswith("sql_data/"))
                  | select(.filename | endswith(".sql"))
                  | .filename' > sql_files.txt

          FILE_COUNT=$(grep -c . sql_files.txt || true)
          echo "sql_file_count=$FILE_COUNT" >> $GITHUB_OUTPUT

          echo "SQL files found:"
          cat sql_files.txt || echo "None"

      # --------------------------------------------------
      # 4. Create Lambda payload JSON
      # --------------------------------------------------
      - name: Create Lambda payload
        if: steps.find_sql.outputs.sql_file_count > 0
        run: |
          echo '{ "files": [' > sql_content.json
          FIRST=true

          while IFS= read -r file; do
            [ -z "$file" ] && continue
            [ "$FIRST" = false ] && echo ',' >> sql_content.json
            FIRST=false
            CONTENT=$(jq -Rs . < "$file")
            echo "  {\"filename\": \"$file\", \"content\": $CONTENT}" >> sql_content.json
          done < sql_files.txt

          echo ']}' >> sql_content.json
          cat sql_content.json

      # --------------------------------------------------
      # 5. Configure AWS credentials
      # --------------------------------------------------
      - name: Configure AWS credentials
        if: steps.find_sql.outputs.sql_file_count > 0
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # --------------------------------------------------
      # 6. Invoke Lambda
      # --------------------------------------------------
      - name: Invoke Lambda
        if: steps.find_sql.outputs.sql_file_count > 0
        run: |
          aws lambda invoke \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --invocation-type RequestResponse \
            --cli-binary-format raw-in-base64-out \
            --payload file://sql_content.json \
            lambda_response.json

          echo "Lambda response:"
          cat lambda_response.json

          if grep -q "FunctionError" lambda_response.json; then
            echo "❌ Lambda execution failed"
            exit 1
          else
            echo "✅ Lambda executed successfully"
          fi

      # --------------------------------------------------
      # 7. PR success comment
      # --------------------------------------------------
      - name: PR success comment
        if: success() && steps.find_sql.outputs.sql_file_count > 0
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "✅ *PR Validation Complete*\n- SQL files processed\n- Lambda executed successfully"

      # --------------------------------------------------
      # 8. PR failure comment
      # --------------------------------------------------
      - name: PR failure comment
        if: failure() && steps.find_sql.outputs.sql_file_count > 0
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "❌ *SQL Processing Failed*\nPlease check GitHub Actions logs."
